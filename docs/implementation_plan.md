# Phase 8 実装計画書: ストア審査と公開

## 1. 目標
本フェーズの目標は、Zaikakuアプリを Google Play ストアへ正式に公開するための全工程を完遂することです。ストアアセットの準備、法的要件の充足、および実機での最終的な品質保証を並行して実施します。

## 2. 作業範囲 (Task.md準拠)

### ステップ1: 事前準備と最終確認 [完了]
- **1.1 リリースビルドの確認**: AAB存在確認、AdMob ID注入確認。
- **1.2 必要素材の準備**: 512x512アイコン、4-8枚のスクリーンショット、フィーチャーグラフィック、プライバシーポリシーURL。

### ステップ2: Google Play Console登録作業（ユーザー実施） [一部完了/進行中]
- **2.1 アプリの作成**: 材確、日本語、アプリ、無料。
- **2.2 ストアの掲載情報**: アプリ名、短い説明、詳しい説明、画像アセット。
- **2.3 カテゴリと連絡先**: ビジネス、サポート用メールアドレス。
- **2.4 プライバシー等**: 各種宣言、データセーフティ。

### ステップ3: リリースのアップロード（ユーザー実施） [一部完了/進行中]
- **3.1 トラック選択**: 製品版。
- **3.2 AABアップロード**: `app-release.aab`。
- **3.3 リリースノート**: 記入。

### ステップ4: 審査と公開（ユーザー実施） [審査中]
- **4.1 審査提出**: 送信済み（2026-02-01 22:14）。

### ステップ5: 実機検証（USB接続テスト） [進行中]
- **5.1 環境構築**: SC-52B 認識完了、インストール成功。
- **5.2 機能検証**: 
  - スキャン種別フィルタ、スキャン範囲（単一）: 合格。
  - スキャン範囲（複数）、バリデーション内容表示: 不合格（下記修正計画にて対応）。

---

## 修正履歴

### [修正完了] スキャン範囲・バリデーション不具合の解消とテスト画像追加
**状態**: 実施済み・一部再検証中  
**策定日**: 2026-02-01 23:45  
**内容**: JAN-8対応、チェックデジット計算厳密化、UIでの詳細エラーメッセージ表示パスの確立、デモ画像(8~11)の追加。

---

## [緊急修正計画] 実機カメラ・遷移不備の解消と物理スキャン復旧
**状態**: **承認待ち**  
**策定日**: 2026-02-02 01:45

実機検証中、エラー表示を閉じた後にシャッターボタンがグレーアウト（非活性）し、物理的なスキャン検証が継続不能になる問題、およびカメラプレビューの不具合を解消します。

### 原因分析
- **ステート管理漏れ**: `ScanNotifier.setError` で `isPendingConfirmation: true` とした際、`clearError` (エラー画面を閉じる) でこのフラグを `false` に戻す処理が漏れていた。
- **論理ロック**: 上記により、画面上はエラーが消えても、内部的には「確認待ち」が続き、シャッターボタンの `onTap` がブロックされたままとなった。

### Proposed Changes

#### 1. [ScanStateProvider] [scan_state_provider.dart](file:///c:/Users/d-2/OriginalCode/Zaikaku/lib/features/scan/presentation/providers/scan_state_provider.dart)
- `ScanNotifier.clearError()` を修正し、`isPendingConfirmation: false` を明示的に設定します。これにより、エラー解消後にシステムが即座に「待機中」から「スキャン可能」へ復帰することを保証します。

#### 2. [ScanScreen] [scan_screen.dart](file:///c:/Users/d-2/OriginalCode/Zaikaku/lib/features/scan/presentation/scan_screen.dart)
- `_onBarcodeDetected` のガード条件 (`!_isScanTriggered`) と `isPendingConfirmation` の整合性を再点検し、物理シャッター押下時のスキャン動作が論理的にブロックされないようにします。
- **戻るボタンの修正**: `context.pop()` 実行前に `Navigator.of(context).canPop()` を確認し、pop できない場合は明示的にホーム (`context.go('/')`) へ遷移させるガード処理を追加します。
- カメラプレビューがグレーアウトしたように見える事象について、ウィジェットの再構築タイミングとコントローラ状態を再点検し、安定化させます。

#### 3. [Main] [main.dart](file:///c:/Users/d-2/OriginalCode/Zaikaku/lib/main.dart)
- `GoRouter` の `initialLocation` をデバッグ用の `/scan` から `/` (ホーム) へ戻し、ユーザーが想定する起動フローを復旧させます。

### Verification Plan (実機検証: SC-52B)
- [ ] 1. アプリ起動時に「ホーム画面」が立ち上がること。
- [ ] 2. ホーム画面から「スキャン開始」を押し、スキャン画面へ遷移すること。
- [ ] 3. スキャン画面の左上「戻るボタン」を押し、ホームへ戻れることを確認。
- [ ] 4. 物理バーコード（またはPC画面）のスキャンにより、意図的にエラーを発生させる。
- [ ] 5. エラーメッセージ（チェックデジットエラー等）が正しく表示されることを確認。
- [ ] 6. 「閉じる」ボタンを押した後、シャッターボタンが赤く（活性化）戻り、即座に次のスキャンが可能になることを確認。
