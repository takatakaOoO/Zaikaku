# 実装計画書 - Phase 5: 出力機能と仕上げ [一部修正]

## 目標
蓄積されたスキャン履歴データを外部（CSVファイル）に出力・共有できるようにし、業務フロー全体の完結性を高めます。また、本番利用に耐えうるUIの調整（アニメーション、遷移のスムーズ化、ダイナミックカラー対応）と、スキャンフローの厳密化（連続スキャン防止のための待機状態）を行い、アプリの完成度を高めます。

## ユーザーレビューを受け修正・追加された要件 (2026-02-01)
ユーザーからのフィードバックに基づき、スキャン画面（ScanScreen）の大幅な仕様変更を行います。

1.  **スキャン方式の変更**: 自動検出（常時スキャン）を廃止し、**シャッターボタンを押したタイミングでのみ読み取り**を行う手動スキャン方式に変更します。
2.  **結果表示位置の変更**: 画面下部のパネル表示をやめ、**カメラプレビューの上（オーバーレイ）**に結果を表示します。
3.  **ガイド枠（オーバーレイ）のデザイン変更**:
    *   「確認ボタン」と重なる黒・黄色のライン（Narrowモード表示）を修正します。
    *   黄色の枠線を、**白背景でも認識しやすい色（赤色など）**に変更します。
4.  **「確認して次へ」フローの維持**: 手動スキャン後も、結果を確認してから次へ進む（リセットする）フローは維持します。

## 変更内容

### 1. スキャン機能 (`ScanScreen` / `ScanNotifier`)
- **[MODIFY] `isScanning` 制御の変更**: 常に検知イベントをフックしますが、シャッターボタンが押されたフラグ（またはイベント）が発生していない場合はバーコードデータを破棄します。
- **[NEW] シャッターボタン**: 画面下部に配置し、ユーザーがスキャンしたいタイミングで押下できるようにします。

### 2. UIレイアウト (`ScanScreen`)
- **[MODIFY] 画面構成**:
  - `Column` レイアウトを見直し、`Stack` をメインにしてカメラ画像を全画面（または大きく）表示します。
  - **結果表示**: 画面上部に、半透明のカードまたはバナーとして結果（OK/NG + 製品情報）を表示します。
  - **シャッターボタン**: 画面下部中央に配置します。
  - **操作パネル**: 製品選択や設定ボタンなどの配置を調整します。
- **[MODIFY] ガイド枠 (`_buildScanOverlay`)**:
  - 色を `Colors.red` または視認性の高い色に変更します。
  - ボタン等と重ならないように位置を調整します。

---

## 検証計画

### 手動検証
1.  **シャッター動作**: カメラをバーコードに向けても自動で読み取られず、ボタンを押したときだけスキャンされることを確認。
2.  **結果表示**: スキャン後、カメラ映像の上に結果（OK/NG）が表示されることを確認。
3.  **視認性**: 明るい背景（白壁など）に向けてもガイド枠がはっきり見えることを確認。
4.  **ボタン操作**: 「確認して次へ」ボタンが他の要素と重ならず、正しく押せることを確認。

## 実装のステップ
1. [x] ステップ1: CSV生成・保存ロジックの実装
2. [x] ステップ2: 履歴画面へのエクスポートボタン実装
3. [x] ステップ3: スキャン方式の変更（自動→シャッター手動）
4. [x] ステップ4: UIレイアウトの大幅改修（結果表示位置、ガイド枠色、ボタン配置）
5. [x] ステップ5: 追加UI改修 (Phase 5.1/5.2/5.3/5.4)
   - 戻るボタンの追加、デモアイコン削除
   - 確認ボタン押下時の結果クリア処理修正
   - 画面下部への材料リスト表示（可変高さ、半透明）
   - ガイド枠上部移動、シャッターボタン右配置
   - エラーフィードバック（タイムアウト表示）追加
6. [x] ステップ6: 動作確認
