# 実装計画書 - Phase 3: データ永続化とログ機能 [承認済]

## 変更履歴
- 2026-01-31: Phase 3 初版作成

---

## 目標
スキャンした各材料の判定結果をローカルデータベースに保存し、ユーザーが過去の履歴を一覧で確認できるようにします。また、将来的なエクスポート（メール送信等）のための基盤を構築します。

## 実施事項

### 1. データベース層の実装 (Drift/SQLite)
- **DB定義**: `AppDatabase` クラスの作成。
- **テーブル定義**: `ScanHistory` テーブル。
  - `id` (Primary Key)
  - `orderNumber` (製造指示番号)
  - `materialBarcode` (材料バーコード)
  - `isCorrect` (判定結果)
  - `timestamp` (スキャン日時)
  - `errorCode` (エラー内容 - なし, CDエラー等)

### 2. リポジトリ層の実装
- `ScanHistoryRepository` インターフェースと実装。
- スキャン結果の保存機能 `saveResult(ScanHistory history)`。
- 全履歴の取得機能 `getAllHistory()`。

### 3. UI層の実装 (履歴表示)
- **履歴一覧画面 (HistoryScreen)**: 
  - カード形式またはリスト形式での表示。
  - 判定結果に応じたアイコン・カラー表示（正解: 青/緑, 不正解: 赤）。
  - 日時によるソート。
- **メイン画面からの遷移**: `HomeScreen` または `ScanScreen` からの導線。

### 4. 設定機能の拡張
- **背景設定**: ログのエクスポート先（メールアドレス等）を保存するフィールドの追加。

## Verification Plan

### Automated Tests
- **Database Test**: Drift の `InMemoryDatabase` を使用した CRUD 操作の検証。
- **Repository Test**: プロバイダー経由でのデータアクセス検証。

### Manual Verification
1. スキャン画面でバーコードをスキャン。
2. 履歴画面へ移動し、先ほどのスキャン結果が正しく記録されているか確認。
3. アプリを再起動してもデータが保持されているか確認。
4. 設定画面でメールアドレスを変更し、正しく保存されるか確認。

## 実装のステップ
1. [ ] ステップ1: Drift のセットアップとテーブル定義
2. [ ] ステップ2: データベースプロバイダーの実装
3. [ ] ステップ3: 履歴保存ロジックの統合（ScanNotifierへの組み込み）
4. [ ] ステップ4: 履歴一覧画面 UIの実装
5. [ ] ステップ5: 設定画面へのエクスポート先項目追加
6. [ ] ステップ6: 動作確認
