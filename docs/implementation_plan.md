# 実装計画書 - Phase 4: マスタデータ管理機能 [承認済]

## 変更履歴
- 2026-01-31: Phase 4 初版作成・承認

---

## 目標
製品情報（型式・バーコード）を管理する「製品マスタ」機能を実装し、検証ロジックをハードコード（またはモック）されたものから、データベースに登録されたマスタデータに基づく動的な照合へと切り替えます。ユーザーはアプリ内で検証対象の製品と、その正解バーコードを登録・編集・削除できるようになります。

## 実施事項

### 1. データベース層の実装 (Drift/SQLite)
- **テーブル定義の追加**:
  - `Products` テーブル:
    - `id` (Auto-increment)
    - `name` (製品名)
    - `modelNumber` (型番/コード)
    - `createdAt`, `updatedAt`
  - `ProductMaterials` テーブル (1対多のリレーション):
    - `id` (Auto-increment)
    - `productId` (Products.id への外部キー)
    - `barcode` (有効な材料バーコード)
    - `createdAt`

### 2. リポジトリ層の実装
- `ProductRepository` インターフェースと実装:
  - `getAllProducts()`: 全製品リスト取得
  - `getProduct(id)`: IDによる製品取得（材料リスト込み）
  - `createProduct(name, modelNumber, materials)`: 製品登録
  - `updateProduct(...)`: 製品更新
  - `deleteProduct(id)`: 製品削除

### 3. UI層の実装 (マスタ管理)
- **製品一覧画面 (ProductListScreen)**:
  - 登録済み製品のリスト表示。
  - 追加ボタン、編集/削除アクション。
- **製品登録・編集画面 (ProductEditScreen)**:
  - 製品名、型番の入力フォーム。
  - **材料バーコード登録**:
    - リスト表示（追加/削除可能）。
    - 「スキャンして追加」ボタン（カメラまたは画像選択でバーコード入力）。
- **スキャン画面 (ScanScreen) の改修**:
  - 画面上部などで「対象製品」を選択するUI（またはモック指示書の代わりに、登録された製品から選択して検証を開始するフロー）。
  - ※今回は簡易的に「設定」または「ホーム」で「アクティブな製品」を選択する形式、あるいはスキャン画面で製品を選択する形式を想定。

### 4. ドメイン層 (検証ロジック) の変更
- `VerifyMaterialUseCase` の変更:
  - 現在の `ManufacturingOrder` (モック) 依存から、選択された `Product` (マスタ) の材料リストに基づく判定へ変更。
  - `ScanNotifier` が「現在のターゲット製品」を保持するように修正。

## Verification Plan

### Automated Tests
- **Database Test**: `Products` と `ProductMaterials` の CRUD テスト、および `Cascading Delete` (製品削除時に材料も消えるか) の検証。
- **Repository Test**: リポジトリメソッドの単体テスト。

### Manual Verification
1. **製品登録**:
   - アプリ上で新しい製品「Test Product」を作成。
   - 材料バーコードとして「12345」と「ABCDE」を登録（手入力およびスキャン入力）。
   - 保存し、一覧に表示されることを確認。
2. **製品編集**:
   - 「12345」を削除し、「67890」を追加。保存されることを確認。
3. **照合検証**:
   - スキャン画面で「Test Product」を選択（またはアクティブ化）。
   - 「ABCDE」をスキャン -> **正解** (OK音)。
   - 「12345」をスキャン -> **不正解** (NG音/削除済みのため)。
   - 「67890」をスキャン -> **正解** (OK音)。
   - 「99999」をスキャン -> **不正解** (NG音)。
4. **製品削除**:
   - 「Test Product」を削除。一覧から消えることを確認。

## 実装のステップ
1. [x] ステップ1: Driftテーブル定義 (`Products`, `ProductMaterials`) とマイグレーション
2. [x] ステップ2: `ProductRepository` の実装
3. [x] ステップ3: 製品一覧・登録・編集画面 (UI) の実装
4. [x] ステップ4: バーコード入力補助機能 (スキャンして追加) の実装
5. [x] ステップ5: `ScanNotifier` / `VerifyMaterialUseCase` のマスタデータ連携
6. [x] ステップ6: 動作確認 (登録〜照合フロー)

## Phase 4.5: OCR入力機能 (製品名・型番) [完了]

### 目標
製品登録時の作業負荷を軽減するため、カメラを使用したOCR（文字認識）機能を追加し、製品名や型番を自動入力できるようにします。

### 実施事項

#### 1. 依存関係の追加
- `google_mlkit_text_recognition`: 英数字（型番）認識用。
- `google_mlkit_text_recognition_japanese`: 日本語（製品名）認識用。

#### 2. OCRスキャン画面 (OCRScanScreen) の実装
- カメラプレビューを表示し、リアルタイムまたは撮影画像のテキストを解析。
- **機能**:
  - テキストブロックのオーバーレイ表示。
  - 認識されたテキストをタップして選択。
  - 選択したテキストを呼び出し元（登録画面）に返す。
  - テキスト補正（改行の除去など）。

#### 3. 製品登録・編集画面 (ProductEditScreen) の改修
- 「製品名」および「型番」入力欄の横に「OCR入力（カメラ）」ボタンを追加。
- ボタン押下で `OCRScanScreen` を起動し、結果を入力欄に反映。

### 検証計画
- **文字認識精度**: エミュレータ（画像使用）または実機にて、型番（英数字）と製品名（日本語）が正しく認識されるか確認。
- **UI動作**: ボタンからカメラ起動 -> テキスト選択 -> フォーム反映 のフローがスムーズか確認。

### 実装のステップ
1. [x] パッケージ導入 (`pubspec.yaml` 更新/設定追加)
2. [x] `OCRScanScreen` の実装
3. [x] `ProductEditScreen` へのボタン追加と連携
