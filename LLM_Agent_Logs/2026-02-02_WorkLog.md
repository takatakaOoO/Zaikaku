# 2026-02-02 作業ログ：バリデーションエラー表示の修正および実機不具合対応

## 1. 課題の再定義
- **現象**: 実機においてデモ画像を使用しても「不正解」とだけ表示され、CDエラー等の詳細メッセージが出ない。
- **ユーザー指摘**: 検知自体ができているか不明。調査を優先すること。

## 2. 調査フェーズ（迷走と解決）
- **ログ収集の難航**: 
    - Windows環境の `flutter run` で実機ログがリアルタイムに表示されない問題に直面。
- **診断コードの注入**:
    - `ScanScreen.initState` に自動スキャンコードを注入。
    - `initialLocation` を `/scan` に変更して起動直後に検証。
- **真因の特定**:
    - `BarcodeValidator` が JAN-8 のテストケース (`49012345`) を `isValid: true` と判定していることを発見。
    - 原因：UPC-A ロジックとの混同。またUI側でのメッセージ表示パスの欠落。

## 3. 修正フェーズ
- **BarcodeValidatorの厳密化**: JAN-13, JAN-8, UPC-A のウェイト計算を規格に合わせて完全に分離。
- **UI表示の改善**: `ValidationResult.errorMessage` をUIに優先表示するよう修正。

## 4. 追加修正：実機カメラ・シャッター不具合の解決
- **現象**: エラー解消後、シャッターボタンがグレーアウトし物理スキャン不可。
- **原因**: `ScanNotifier.clearError` での状態リセット漏れ、および `ScanScreen` でのリスナー過剰登録。
- **対応**: フラグ管理の修正とコントローラ制御の適正化（autoStart: true）。

## 5. 追加修正：初期画面の復旧と遷移機能（戻るボタン）の不備修正
- **現象**: 起動時に直接スキャン画面が開き、戻るボタンが効かない。
- **原因**: 
  1. `initialLocation` が `/scan` のままだった。
  2. 起動スタックが空のため `pop()` が無効だった。
- **対応**: 
  1. `initialLocation` を `/` に復旧。
  2. 戻るボタンに `canPop` ガードと `context.go('/')` の代替遷移を追加。

## 6. クリーンアップ
- すべての `print` 文を `debugPrint` に置換、または削除。不要な検証コードの完全除去。

## 7. 最終結果
- 実機（SC-52B）にて、ホーム起動、戻るボタン、物理スキャン、バリデーションエラー表示のすべてが正常に動作することを確認し、検証フェーズを完了。
